<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title> PEAK | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        peak: {
                            bg: '#0f172a', // Slate 900
                            card: 'rgba(30, 41, 59, 0.7)', // Slate 800 with opacity
                            accent: '#06b6d4', // Cyan 500
                            mobile: '#8b5cf6', // Violet 500
                            danger: '#ef4444', // Red 500
                            success: '#10b981', // Emerald 500
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background-attachment: fixed; color: #e2e8f0; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader { border-top-color: #06b6d4; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm font-sans selection:bg-cyan-500 selection:text-white">

    <aside class="w-64 glass-panel border-r border-white/10 flex flex-col justify-between hidden md:flex z-20">
        <div>
            <div class="p-6 flex items-center gap-3 border-b border-white/5">
                <div class="h-8 w-8 rounded bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold shadow-lg shadow-cyan-500/20">
                    <i class="fas fa-mountain"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">PEAK <span class="text-cyan-400 text-xs font-mono">v2.0</span></h1>
            </div>

            <div class="p-4">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Active Projects</h3>
                    <button onclick="document.getElementById('createProjectModal').classList.remove('hidden')" class="text-cyan-400 hover:text-cyan-300 transition"><i class="fas fa-plus-circle"></i></button>
                </div>
                <ul class="space-y-1 max-h-[60vh] overflow-y-auto custom-scrollbar pr-1">
                    {% for project in projects %}
                    <li>
                        <form action="{{ url_for('select_project_route', project_id=project['id']) }}" method="POST">
                            <button type="submit" class="w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 transition-all duration-200 group {% if project['id'] == current_project_id %} bg-cyan-500/10 text-cyan-300 border border-cyan-500/30 {% else %} hover:bg-white/5 text-gray-400 {% endif %}">
                                <i class="fas fa-folder {% if project['id'] == current_project_id %} text-cyan-400 {% else %} text-gray-600 group-hover:text-gray-400 {% endif %}"></i>
                                <span class="truncate font-medium">{{ project['name'] }}</span>
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="p-4 border-t border-white/5 bg-black/20">
            <div class="flex items-center gap-3 mb-3">
                <div class="h-8 w-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-mono border border-gray-600">{{ username[:2].upper() }}</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-semibold text-white truncate">{{ username }}</p>
                    <p class="text-xs text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online</p>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="block w-full text-center py-2 rounded border border-gray-700 hover:bg-red-500/10 hover:border-red-500/50 hover:text-red-400 transition text-xs font-mono">
                <i class="fas fa-power-off mr-2"></i>DISCONNECT
            </a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <header class="h-16 glass-panel border-b border-white/10 flex items-center justify-between px-6 z-10">
            <div class="flex items-center gap-4">
                {% if current_project_name %}
                    <span class="px-3 py-1 rounded-full bg-cyan-500/10 border border-cyan-500/30 text-cyan-300 text-xs font-mono">
                        <i class="fas fa-crosshairs mr-2"></i>{{ current_project_name }}
                    </span>
                    <span class="text-gray-500 text-xs font-mono hidden sm:inline">{{ current_session_id }}</span>
                {% else %}
                    <span class="text-gray-400 italic">No Target Selected</span>
                {% endif %}
            </div>
            
            <div class="flex items-center gap-4">
                {% if is_2fa_enabled %}
                    <span class="text-green-400 text-xs" title="2FA Secured"><i class="fas fa-shield-alt"></i></span>
                {% else %}
                    <form action="{{ url_for('toggle_2fa') }}" method="POST">
                        <button class="text-red-400 hover:text-red-300 text-xs transition" title="Enable 2FA"><i class="fas fa-shield-virus"></i> Enable 2FA</button>
                    </form>
                {% endif %}
            </div>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 relative">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-6 p-4 rounded-lg border backdrop-blur-md flex items-center gap-3 animate-fade-in
                            {% if category == 'success' %} bg-green-500/10 border-green-500/30 text-green-300
                            {% elif category == 'danger' %} bg-red-500/10 border-red-500/30 text-red-300
                            {% else %} bg-blue-500/10 border-blue-500/30 text-blue-300 {% endif %}">
                            <i class="fas fa-info-circle"></i> {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if current_project_id %}
            
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                
                <div class="glass-panel rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-white/5 bg-gradient-to-r from-cyan-900/20 to-transparent">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="font-bold text-white text-lg flex items-center gap-2">
                                    <i class="fas fa-brain text-cyan-400"></i> PEAK
                                </h2>
                                <p class="text-cyan-300 text-xs font-mono tracking-wide mt-1">Proactive Engine Assessment Kit</p>
                                <p class="text-gray-500 text-[10px]">Profiling, Enumeration & Attack Kit</p>
                            </div>
                            <span class="text-xs text-cyan-500 font-mono border border-cyan-500/30 px-2 py-0.5 rounded">v2.0 ACTIVE</span>
                        </div>
                    </div>

                    <div class="p-6 flex-1">
                        <div class="relative">
                            <input id="peakUrlInput" type="text" placeholder="https://target-system.com" 
                                class="w-full bg-black/30 border border-gray-700 rounded-lg py-3 px-4 pl-10 text-white focus:outline-none focus:border-cyan-500 transition font-mono text-sm">
                            <i class="fas fa-globe absolute left-3 top-3.5 text-gray-500"></i>
                            <button onclick="runPeakAnalysis()" class="absolute right-1 top-1 bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-md text-xs font-bold transition">
                                PROBE
                            </button>
                        </div>

                        <div id="peakResults" class="hidden mt-6 space-y-4">
                            <div class="flex justify-end">
                                <button onclick="exportPeakReport()" class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition flex items-center gap-2">
                                    <i class="fas fa-file-csv"></i> Export Report
                                </button>
                            </div>

                            <div class="bg-black/40 rounded border border-gray-700 p-3">
                                <div class="text-xs text-gray-400 uppercase font-bold mb-2">Technological Fingerprint</div>
                                <div id="peakStackList" class="flex flex-wrap gap-2"></div>
                            </div>
                            
                            <div class="bg-black/40 rounded border border-gray-700 p-3 relative">
                                <div class="text-xs text-gray-400 uppercase font-bold mb-2 flex justify-between">
                                    <span>Attack Vector Analysis</span>
                                    <i class="fas fa-robot text-purple-400"></i>
                                </div>
                                <div id="peakAiPlan" class="font-mono text-xs text-gray-300 whitespace-pre-wrap max-h-64 overflow-y-auto custom-scrollbar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-white/5 bg-gradient-to-r from-purple-900/20 to-transparent flex justify-between items-center">
                        <h2 class="font-bold text-white flex items-center gap-2">
                            <i class="fas fa-mobile-alt text-purple-400"></i> Mobile SAST
                        </h2>
                        <span class="text-xs text-purple-500 font-mono">MOBSF // READY</span>
                    </div>
                    <div class="p-6 flex-1 flex flex-col justify-center">
                        <div class="border-2 border-dashed border-gray-700 rounded-xl p-8 text-center hover:border-purple-500/50 transition bg-black/20 group cursor-pointer relative">
                            <input type="file" id="mobileFileUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
                            <div class="group-hover:-translate-y-1 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-600 group-hover:text-purple-400 mb-3"></i>
                                <p class="text-gray-400 font-medium group-hover:text-white" id="uploadText">Drop APK / IPA here</p>
                                <p class="text-xs text-gray-600 mt-1">Max size: 100MB</p>
                            </div>
                        </div>
                        <button onclick="uploadAndScanMobile()" class="w-full mt-4 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg font-bold text-sm transition shadow-lg shadow-purple-900/20">
                            INITIALIZE STATIC ANALYSIS
                        </button>

                        <div id="mobileScanResult" class="hidden mt-6">
                            <div id="mobileOutputContent" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="glass-panel rounded-xl overflow-hidden border-t-2 border-t-cyan-500">
                <div class="bg-gray-900 px-4 py-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-terminal text-green-500 text-xs"></i>
                        <span class="text-xs font-mono text-gray-400">root@peak-agent:~#</span>
                    </div>
                    <button onclick="clearConsole()" class="text-xs text-gray-500 hover:text-white transition uppercase font-mono">
                        [ Clear Output ]
                    </button>
                </div>
                
                <div class="p-0 bg-black/80 font-mono text-sm">
                    <div id="consoleOutput" class="h-96 overflow-y-auto p-4 custom-scrollbar text-gray-300 space-y-4">
                        <div class="text-gray-500">
                            P.E.A.K System Online.<br>
                            Type 'help' for available commands.
                        </div>
                    </div>
                    
                    <div class="flex items-center border-t border-gray-800">
                        <span class="pl-4 py-3 text-cyan-500 font-bold">‚ùØ</span>
                        <input type="text" id="commandInput" class="w-full bg-transparent border-none text-white px-3 py-3 focus:ring-0 placeholder-gray-700" placeholder="Enter command (e.g., scan 192.168.1.1)..." onkeydown="if(event.key === 'Enter') sendCommand()">
                        <button onclick="sendCommand()" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-cyan-500 font-bold border-l border-gray-700 transition">
                            EXEC
                        </button>
                    </div>
                </div>
            </div>

            {% else %}
            <div class="h-[70vh] flex flex-col items-center justify-center text-center">
                <div class="h-24 w-24 rounded-full bg-white/5 flex items-center justify-center mb-6 animate-pulse">
                    <i class="fas fa-folder-open text-4xl text-gray-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">No Project Selected</h2>
                <p class="text-gray-400 max-w-md mx-auto mb-8">Select a project from the sidebar or initialize a new engagement to access the PEAK toolset.</p>
                <button onclick="document.getElementById('createProjectModal').classList.remove('hidden')" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold transition shadow-lg shadow-cyan-500/20">
                    Create New Project
                </button>
            </div>
            {% endif %}

        </div>
    </main>

    <div id="createProjectModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 border border-white/10 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4">Initialize New Engagement</h3>
            <form action="{{ url_for('create_project_route') }}" method="POST">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Project Name</label>
                <input type="text" name="project_name" class="w-full bg-black/40 border border-gray-600 rounded-lg p-3 text-white focus:border-cyan-500 focus:outline-none mb-6" placeholder="e.g., Internal PenTest Q1" required>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('createProjectModal').classList.add('hidden')" class="px-4 py-2 rounded text-gray-400 hover:text-white hover:bg-white/5 transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold transition">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // GLOBAL DATA STORE FOR EXPORT
        let lastPeakData = null;

        // 1. CLEAR CONSOLE FUNCTION
        function clearConsole() {
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.innerHTML = '<div class="text-gray-500 italic">Console output cleared. System ready.</div>';
        }

        // 2. MOBILE FILE HANDLER UI
        function handleFileSelect(input) {
            const fileName = input.files[0].name;
            document.getElementById('uploadText').innerHTML = `<span class="text-purple-300">${fileName}</span>`;
        }

        // 3. P.E.A.K ANALYSIS (UPDATED TO FIX UNDEFINED)
        async function runPeakAnalysis() {
            const url = document.getElementById('peakUrlInput').value;
            const stackList = document.getElementById('peakStackList');
            const aiPlan = document.getElementById('peakAiPlan');
            const container = document.getElementById('peakResults');

            if(!url) return alert("Enter URL");

            container.classList.remove('hidden');
            stackList.innerHTML = '<span class="text-cyan-500 animate-pulse">Scanning Headers & Probing Paths...</span>';
            aiPlan.innerHTML = '<span class="text-purple-500 animate-pulse">Neural Network is thinking... (This may take 1-3 mins)</span>';

            try {
                const res = await fetch('/api/peak/analyze', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({url})
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    // STORE DATA FOR EXPORT
                    lastPeakData = data; 
                    
                    // Render Tech Stack
                    let stackHtml = "";
                    if (data.tech_stack && data.tech_stack.length > 0) {
                        stackHtml = data.tech_stack.map(t => 
                            `<span class="bg-cyan-900/40 text-cyan-300 border border-cyan-500/30 px-2 py-1 rounded text-[10px] font-mono">${t}</span>`
                        ).join('');
                    } else {
                        stackHtml = '<span class="text-gray-500 text-xs">No specific tech detected.</span>';
                    }

                    // Render Exposed Paths
                    if(data.exposed_paths && data.exposed_paths.length > 0) {
                         stackHtml += `<div class="w-full mt-2 pt-2 border-t border-gray-700"></div>`;
                         data.exposed_paths.forEach(path => {
                             stackHtml += `<div class="flex items-center gap-2 text-red-400 font-bold text-xs mt-1 animate-pulse border border-red-500/30 bg-red-900/20 p-1 rounded"><i class="fas fa-exclamation-triangle"></i> EXPOSED: ${path}</div>`;
                         });
                    } else {
                        stackHtml += `<div class="w-full mt-2 pt-2 border-t border-gray-700 text-[10px] text-green-400"><i class="fas fa-check-circle"></i> No sensitive paths exposed.</div>`;
                    }
                    
                    stackList.innerHTML = stackHtml;
                    
                    // Render Plan (Fix for Undefined)
                    // We check for 'ai_plan_html' (New backend) OR 'ai_plan' (Old backend)
                    const planContent = data.ai_plan_html || data.ai_plan || "No AI plan generated.";
                    aiPlan.innerHTML = planContent;
                    
                } else {
                    aiPlan.innerHTML = `<span class="text-red-400">Error: ${data.message}</span>`;
                    stackList.innerHTML = `<span class="text-red-400">Failed</span>`;
                }
            } catch(e) {
                console.error(e);
                aiPlan.innerHTML = `<span class="text-red-400">Connection Error: ${e.message}</span>`;
            }
        }

        // 4. EXPORT FUNCTION
        async function exportPeakReport() {
            if (!lastPeakData) {
                alert("No scan data to export. Run a scan first.");
                return;
            }

            try {
                const res = await fetch('/api/peak/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(lastPeakData)
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `PEAK_Report_${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert("Failed to generate CSV.");
                }
            } catch (e) {
                alert("Export error: " + e);
            }
        }

        // 5. MOBILE SCAN
        async function uploadAndScanMobile() {
            const input = document.getElementById('mobileFileUpload');
            const output = document.getElementById('mobileScanResult');
            const content = document.getElementById('mobileOutputContent');
            
            if(!input.files[0]) return alert("Select File");

            output.classList.remove('hidden');
            content.innerHTML = '<div class="text-purple-400 animate-pulse text-center p-4">Uploading & Decompiling... This may take 2 mins.</div>';
            
            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch('/api/scan/mobile', { method:'POST', body:formData });
                const data = await res.json();

                if(data.error) {
                    content.innerHTML = `<div class="text-red-400 p-4 border border-red-500/50 bg-red-900/20 rounded">Error: ${data.error}</div>`;
                } else {
                    let html = `
                        <div class="flex items-center justify-between bg-black/40 p-3 rounded border border-gray-700">
                            <div class="text-gray-400 text-xs uppercase font-bold">Security Score</div>
                            <div class="text-2xl font-bold ${data.security_score < 50 ? 'text-red-500' : 'text-green-400'}">${data.security_score}/100</div>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                    `;
                    
                    if(data.high_issues && data.high_issues.length > 0) {
                        data.high_issues.forEach(i => {
                            html += `
                                <div class="bg-red-500/10 border border-red-500/20 p-3 rounded hover:bg-red-500/20 transition">
                                    <div class="text-red-400 font-bold text-xs mb-1"><i class="fas fa-bug mr-1"></i> ${i.title}</div>
                                    <div class="text-gray-400 text-[10px] leading-tight">${i.description}</div>
                                </div>
                            `;
                        });
                    } else {
                        html += `<div class="text-green-400 text-center text-xs p-4">No Critical Vulnerabilities Found.</div>`;
                    }
                    html += `</div>`;
                    content.innerHTML = html;
                }
            } catch(e) {
                content.innerHTML = `<div class="text-red-400">Network Error</div>`;
            }
        }

        // 6. TERMINAL COMMAND
        async function sendCommand() {
            const input = document.getElementById('commandInput');
            const consoleDiv = document.getElementById('consoleOutput');
            const cmd = input.value;
            if(!cmd) return;

            // Add user command to UI
            consoleDiv.innerHTML += `
                <div class="mt-4">
                    <span class="text-green-500 font-bold">root@peak:~#</span> <span class="text-white">${cmd}</span>
                </div>
                <div class="text-cyan-500 animate-pulse ml-4" id="loading-${Date.now()}">... Processing ...</div>
            `;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            input.value = '';

            try {
                const res = await fetch('/agent_command', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({command:cmd})
                });
                const data = await res.json();
                
                // Remove loading indicator
                consoleDiv.lastElementChild.remove();

                // Append Response
                let outputHtml = `<div class="ml-4 text-gray-300 font-mono text-xs whitespace-pre-wrap border-l-2 border-gray-700 pl-3 py-2 my-2">${data.response_for_ui || data.message}</div>`;
                
                if(data.llm_analysis && data.llm_analysis !== 'N/A' && data.llm_analysis !== 'LLM analysis skipped.') {
                     outputHtml += `<div class="ml-4 mt-2 p-3 bg-cyan-900/10 border border-cyan-500/30 rounded text-xs text-cyan-100">
                        <div class="font-bold text-cyan-400 mb-1"><i class="fas fa-brain"></i> AI Analysis:</div>
                        ${data.llm_analysis}
                     </div>`;
                }

                consoleDiv.innerHTML += outputHtml;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;

            } catch(e) {
                consoleDiv.lastElementChild.remove();
                consoleDiv.innerHTML += `<div class="text-red-500 ml-4">Error executing command.</div>`;
            }
        }
    </script>
</body>
</html>